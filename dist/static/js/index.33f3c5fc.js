(()=>{"use strict";var t,e,o,i,n,r,a={556(t,e,o){var i=o(554),n=o(50),r=o(475),a=o(170),s=o(530),l=o(437),h=o(944),c=o(632),d=o(848);class u{init(){this.scene=new l.Z58,this.scene.background=new l.Q1f(0),this.camera=new l.ubm(75,this.container.clientWidth/this.container.clientHeight,.1,1e4),this.camera.position.set(this.defaultCameraPosition.x,this.defaultCameraPosition.y,this.defaultCameraPosition.z);let t=this.container.clientWidth/this.container.clientHeight;this.orthoCamera=new l.qUd(-(100*t/2),100*t/2,50,-50,.1,1e4),this.activeCamera=this.camera,this.renderer=new l.JeP({antialias:!1}),this.renderer.setSize(this.container.clientWidth,this.container.clientHeight),this.renderer.setPixelRatio(window.devicePixelRatio),this.container.appendChild(this.renderer.domElement),this.controls=new h.N(this.camera,this.renderer.domElement),this.controls.enableDamping=!0,this.controls.dampingFactor=.05,this.controls.screenSpacePanning=!1,this.controls.minDistance=1,this.controls.maxDistance=1e3,this.controls.mouseButtons.LEFT=l.kBv.PAN,this.controls.mouseButtons.RIGHT=l.kBv.ROTATE,this.controls.touches.ONE=l.wtR.PAN,this.controls.touches.TWO=l.wtR.DOLLY_ROTATE;let e=new l.$p8(4210752,.6);this.scene.add(e);let o=new l.ZyN(0xffffff,.8);o.position.set(100,100,100),this.scene.add(o),this.createROSAxesHelper(),this.scene.add(this.waypointGroup),this.scene.add(this.connectionGroup),this.animate()}createROSAxesHelper(){let t=new l.YJl,e=new l.LoY().setFromPoints([new l.Pq0(0,0,0),new l.Pq0(0,0,5)]),o=new l.mrM({color:0xff0000}),i=new l.N1A(e,o);t.add(i);let n=new l.LoY().setFromPoints([new l.Pq0(0,0,0),new l.Pq0(-5,0,0)]),r=new l.mrM({color:65280}),a=new l.N1A(n,r);t.add(a);let s=new l.LoY().setFromPoints([new l.Pq0(0,0,0),new l.Pq0(0,5,0)]),h=new l.mrM({color:255}),c=new l.N1A(s,h);t.add(c),this.scene.add(t)}onWindowResize(){if(!this.camera||!this.renderer||!this.orthoCamera)return;let t=this.container.clientWidth/this.container.clientHeight;this.camera.aspect=t,this.camera.updateProjectionMatrix();let e=2*this.orthoCamera.top;this.orthoCamera.left=-(e*t/2),this.orthoCamera.right=e*t/2,this.orthoCamera.updateProjectionMatrix(),this.renderer.setSize(this.container.clientWidth,this.container.clientHeight)}loadPCDFile(t){this.onLoadStatusChange("加载中..."),this.currentFileName=t.name,this.currentFormat="pcd";let e=URL.createObjectURL(t);this.pcdLoader.load(e,o=>{URL.revokeObjectURL(e);let i=this.extractPCDData(o);this.saveOriginalData(i,"pcd",t.name),this.createPointCloud(i),this.onLoadStatusChange("加载完成"),console.log("Loaded points:",i.count)},t=>{if(t.total>0){let e=Math.round(t.loaded/t.total*100);this.onLoadStatusChange(`加载中... ${e}%`)}},t=>{URL.revokeObjectURL(e),console.error("PCD loading error:",t),this.onLoadStatusChange("错误: "+t.message)})}loadPLYFile(t){this.onLoadStatusChange("加载中..."),this.currentFileName=t.name,this.currentFormat="ply";let e=URL.createObjectURL(t);this.plyLoader.load(e,o=>{URL.revokeObjectURL(e);let i=this.extractGeometryData(o);this.saveOriginalData(i,"ply",t.name),this.createPointCloud(i),this.onLoadStatusChange("加载完成"),console.log("Loaded points:",i.count)},t=>{if(t.total>0){let e=Math.round(t.loaded/t.total*100);this.onLoadStatusChange(`加载中... ${e}%`)}},t=>{URL.revokeObjectURL(e),console.error("PLY loading error:",t),this.onLoadStatusChange("错误: "+t.message)})}async loadLASFile(t){this.onLoadStatusChange("加载中..."),this.currentFileName=t.name,this.currentFormat="las";try{let e=await t.arrayBuffer(),o=this.parseLASFile(e);this.saveOriginalData(o,"las",t.name),this.createPointCloud(o),this.onLoadStatusChange("加载完成"),console.log("Loaded points:",o.count)}catch(t){console.error("LAS loading error:",t),this.onLoadStatusChange("错误: "+t.message)}}cancelLoad(){this.abortController&&(this.abortController.abort(),this.abortController=null),this.worker&&(this.worker.terminate(),this.worker=null),this.onLoadStatusChange("已取消")}async loadFromURL(t){var e,o,i;let n=!(arguments.length>1)||void 0===arguments[1]||arguments[1];this.cancelLoad(),this.onLoadStatusChange("准备下载..."),this.abortController=new AbortController;let r=this.abortController.signal,a=(null==(e=t.toLowerCase().split(".").pop())?void 0:e.split("?")[0])||"",s=(null==(o=t.split("/").pop())?void 0:o.split("?")[0])||"pointcloud."+a;if(this.currentFileName=s,this.currentFormat=a,"ply"===a)return void this.plyLoader.load(t,t=>{let e=this.extractGeometryData(t);this.saveOriginalData(e,"ply",s),this.createPointCloud(e),this.onLoadStatusChange("加载完成"),console.log("Loaded points from URL:",e.count)},t=>{if(t.total>0){let e=Math.round(t.loaded/t.total*100);this.onLoadStatusChange(`下载中... ${e}%`)}},t=>{console.error("PLY loading error from URL:",t),this.onLoadStatusChange("错误: 无法从URL加载文件")});try{let e=await fetch(t,{signal:r});if(!e.ok)throw Error(`HTTP error! status: ${e.status}`);let o=e.headers.get("content-length"),l=o?parseInt(o,10):0,h=null==(i=e.body)?void 0:i.getReader();if(!h)throw Error("无法读取响应流");let c=[],d=0;for(;;){let{done:t,value:e}=await h.read();if(t)break;if(c.push(e),d+=e.length,l>0){let t=Math.round(d/l*100),e=(d/1024/1024).toFixed(1),o=(l/1024/1024).toFixed(1);this.onLoadStatusChange(`下载中... ${t}% (${e}/${o} MB)`)}else{let t=(d/1024/1024).toFixed(1);this.onLoadStatusChange(`下载中... ${t} MB`)}}let u=this.concatenateArrayBuffers(c);this.onLoadStatusChange("下载完成，解析中...");let p=u.byteLength/1024/1024;if(n&&p>5&&("pcd"===a||"las"===a))await this.parseWithWorker(u,a);else if("pcd"===a){let t=new Blob([u]),e=URL.createObjectURL(t);this.pcdLoader.load(e,t=>{URL.revokeObjectURL(e);let o=this.extractPCDData(t);this.saveOriginalData(o,"pcd",s),this.createPointCloud(o),this.onLoadStatusChange("加载完成"),console.log("Loaded points from URL:",o.count)},void 0,t=>{URL.revokeObjectURL(e),console.error("PCD parsing error:",t),this.onLoadStatusChange("错误: 解析失败")})}else if("las"===a){let t=this.parseLASFile(u);this.saveOriginalData(t,"las",s),this.createPointCloud(t),this.onLoadStatusChange("加载完成")}else this.onLoadStatusChange("错误: 不支持的文件格式")}catch(t){if("AbortError"===t.name)return void console.log("加载已取消");console.error("加载错误:",t),this.onLoadStatusChange("错误: "+t.message)}}concatenateArrayBuffers(t){let e=new Uint8Array(t.reduce((t,e)=>t+e.length,0)),o=0;for(let i of t)e.set(i,o),o+=i.length;return e.buffer}parseWithWorker(t,e){return new Promise((i,n)=>{this.worker=new Worker(new URL(o.p+o.u("187"),o.b),Object.assign({},{type:"module"},{type:void 0})),this.worker.onmessage=t=>{var o,r;let a=t.data;if("progress"===a.type)this.onLoadStatusChange(a.message);else if("complete"===a.type){let t={vertices:a.data.vertices,colors:a.data.colors,originalColors:new Float32Array(a.data.colors),count:a.data.count,originalVertices:a.data.originalVertices};this.saveOriginalData(t,e,this.currentFileName),this.createPointCloud(t),this.onLoadStatusChange(`加载完成 (${t.count.toLocaleString()} 点)`),null==(o=this.worker)||o.terminate(),this.worker=null,i()}else"error"===a.type&&(this.onLoadStatusChange("错误: "+a.error),null==(r=this.worker)||r.terminate(),this.worker=null,n(Error(a.error)))},this.worker.onerror=t=>{var e;console.error("Worker error:",t),this.onLoadStatusChange("解析错误"),null==(e=this.worker)||e.terminate(),this.worker=null,n(t)},this.worker.postMessage({type:"pcd"===e?"parse_pcd":"parse_las",data:t},[t])})}loadFromURLLegacy(t){var e;this.onLoadStatusChange("从URL加载中...");let o=(null==(e=t.toLowerCase().split(".").pop())?void 0:e.split("?")[0])||"";"pcd"===o?this.pcdLoader.load(t,t=>{let e=this.extractPCDData(t);this.createPointCloud(e),this.onLoadStatusChange("加载完成"),console.log("Loaded points from URL:",e.count)},t=>{if(t.total>0){let e=Math.round(t.loaded/t.total*100);this.onLoadStatusChange(`加载中... ${e}%`)}},t=>{console.error("PCD loading error from URL:",t),this.onLoadStatusChange("错误: 无法从URL加载文件")}):"ply"===o?this.plyLoader.load(t,t=>{let e=this.extractGeometryData(t);this.createPointCloud(e),this.onLoadStatusChange("加载完成"),console.log("Loaded points from URL:",e.count)},t=>{if(t.total>0){let e=Math.round(t.loaded/t.total*100);this.onLoadStatusChange(`加载中... ${e}%`)}},t=>{console.error("PLY loading error from URL:",t),this.onLoadStatusChange("错误: 无法从URL加载文件")}):"las"===o?this.loadLASFromURL(t):this.onLoadStatusChange("错误: 不支持的文件格式")}async loadLASFromURL(t){try{let e=await fetch(t);if(!e.ok)throw Error(`HTTP error! status: ${e.status}`);let o=await e.arrayBuffer(),i=this.parseLASFile(o);this.createPointCloud(i),this.onLoadStatusChange("加载完成"),console.log("Loaded LAS points from URL:",i.count)}catch(t){console.error("LAS loading error from URL:",t),this.onLoadStatusChange("错误: "+t.message)}}parseLASFile(t){let e,o=new DataView(t);if("LASF"!==String.fromCharCode(o.getUint8(0),o.getUint8(1),o.getUint8(2),o.getUint8(3)))throw Error("无效的 LAS 文件格式");let i=o.getUint8(24),n=o.getUint8(25);console.log(`LAS 版本: ${i}.${n}`);let r=o.getUint32(96,!0),a=o.getUint8(104),s=o.getUint16(105,!0);e=1===i&&n<4?o.getUint32(107,!0):Number(o.getBigUint64(247,!0)),console.log(`点数量: ${e}, 格式: ${a}`);let l=o.getFloat64(131,!0),h=o.getFloat64(139,!0),c=o.getFloat64(147,!0),d=o.getFloat64(155,!0),u=o.getFloat64(163,!0),p=o.getFloat64(171,!0),g=new Float32Array(3*e),m=new Float32Array(3*e),y=new Float32Array(3*e),C=[2,3,5,7,8,10].includes(a),w=2===a?20:28*(3===a);for(let t=0;t<e;t++){let e=r+t*s,i=o.getInt32(e,!0),n=o.getInt32(e+4,!0),a=o.getInt32(e+8,!0),f=i*l+d,x=n*h+u,v=a*c+p;if(m[3*t]=f,m[3*t+1]=x,m[3*t+2]=v,g[3*t]=-x,g[3*t+1]=v,g[3*t+2]=-f,C&&w>0){let i=o.getUint16(e+w,!0)/65535,n=o.getUint16(e+w+2,!0)/65535,r=o.getUint16(e+w+4,!0)/65535;y[3*t]=i,y[3*t+1]=n,y[3*t+2]=r}else y[3*t]=.7,y[3*t+1]=.7,y[3*t+2]=.7}return{vertices:g,colors:y,originalColors:new Float32Array(y),count:e,originalVertices:m}}extractPCDData(t){let e,o=t.geometry,i=o.attributes.position.array,n=i.length/3;if(o.attributes.color)e=new Float32Array(o.attributes.color.array);else{e=new Float32Array(3*n);for(let t=0;t<n;t++)e[3*t]=.7,e[3*t+1]=.7,e[3*t+2]=.7}let r=new Float32Array(i),a=new Float32Array(i.length);for(let t=0;t<n;t++){let e=i[3*t],o=i[3*t+1],n=i[3*t+2];a[3*t]=-o,a[3*t+1]=n,a[3*t+2]=-e}return console.log("Extracted vertices:",n),{vertices:a,colors:e,count:n,originalColors:new Float32Array(e),originalVertices:r}}extractGeometryData(t){let e,o=t.attributes.position.array,i=o.length/3;if(t.attributes.color)e=new Float32Array(t.attributes.color.array);else{e=new Float32Array(3*i);for(let t=0;t<i;t++)e[3*t]=.7,e[3*t+1]=.7,e[3*t+2]=.7}let n=new Float32Array(o),r=new Float32Array(o.length);for(let t=0;t<i;t++){let e=o[3*t],i=o[3*t+1],n=o[3*t+2];r[3*t]=-i,r[3*t+1]=n,r[3*t+2]=-e}return{vertices:r,colors:e,count:i,originalColors:new Float32Array(e),originalVertices:n}}createPointCloud(t){let e=!(arguments.length>1)||void 0===arguments[1]||arguments[1];this.pointCloud&&this.scene&&(this.scene.remove(this.pointCloud),this.pointCloud.geometry.dispose(),this.pointCloud.material.dispose()),this.currentPCDData=t,this.calculateHeightRange(t);let o=this.applyHeightFilter(t),i=this.downsampleLevel>1?this.downsamplePointCloud(o,this.downsampleLevel):o,n=this.calculateColors(i),r=new l.LoY;r.setAttribute("position",new l.THS(i.vertices,3)),r.setAttribute("color",new l.THS(n,3));let a=new l.BH$({size:.05,vertexColors:!0,sizeAttenuation:!0});if(this.pointCloud=new l.ONl(r,a),this.pointCloud.frustumCulled=!0,this.scene.add(this.pointCloud),r.computeBoundingBox(),e){let t=r.boundingBox;if(t&&this.camera&&this.controls){let e=new l.Pq0;t.getCenter(e);let o=new l.Pq0;t.getSize(o);let i=.4*Math.max(o.x,o.y,o.z);this.camera.position.set(e.x+i,e.y+i,e.z+i),this.controls.target.copy(e),this.controls.update()}}let s=i.count,h=o.count;this.downsampleLevel>1?(this.onPointCountChange(s),console.log(`渲染 ${s.toLocaleString()} / ${h.toLocaleString()} 点 (降采样 ${this.downsampleLevel}x)`)):this.onPointCountChange(s)}downsamplePointCloud(t,e){if(e<=1)return t;let o=t.count,i=Math.ceil(o/e),n=new Float32Array(3*i),r=new Float32Array(3*i),a=new Float32Array(3*i);for(let s=0,l=0;s<o&&l<i;s+=e,l++)n[3*l]=t.vertices[3*s],n[3*l+1]=t.vertices[3*s+1],n[3*l+2]=t.vertices[3*s+2],r[3*l]=t.colors[3*s],r[3*l+1]=t.colors[3*s+1],r[3*l+2]=t.colors[3*s+2],a[3*l]=t.originalColors[3*s],a[3*l+1]=t.originalColors[3*s+1],a[3*l+2]=t.originalColors[3*s+2];return{vertices:n,colors:r,originalColors:a,count:i}}setDownsampleLevel(t){this.downsampleLevel=Math.max(1,t),this.currentPCDData&&this.createPointCloud(this.currentPCDData,!1)}resetCamera(){if(this.camera&&this.controls){if(this.isOrthoView&&this.setPerspectiveView(),this.pointCloud&&this.pointCloud.geometry.boundingBox){let t=this.pointCloud.geometry.boundingBox,e=new l.Pq0;t.getCenter(e);let o=new l.Pq0;t.getSize(o);let i=.6*Math.max(o.x,o.y,o.z);this.camera.position.set(e.x+i,e.y+i,e.z+i),this.controls.target.copy(e)}else this.camera.position.set(this.defaultCameraPosition.x,this.defaultCameraPosition.y,this.defaultCameraPosition.z),this.controls.target.set(0,0,0);this.controls.update()}}setTopView(){if(!this.orthoCamera||!this.controls||!this.renderer)return;let t=new l.Pq0(0,0,0),e=100;if(this.pointCloud&&this.pointCloud.geometry.boundingBox){let o=this.pointCloud.geometry.boundingBox;o.getCenter(t);let i=new l.Pq0;o.getSize(i),e=1.2*Math.max(i.x,i.z)}let o=this.container.clientWidth/this.container.clientHeight;this.orthoCamera.left=-(e*o/2),this.orthoCamera.right=e*o/2,this.orthoCamera.top=e/2,this.orthoCamera.bottom=-(e/2),this.orthoCamera.updateProjectionMatrix(),this.orthoCamera.position.set(t.x,t.y+1e3,t.z),this.orthoCamera.lookAt(t),this.activeCamera=this.orthoCamera,this.isOrthoView=!0,this.controls.object=this.orthoCamera,this.controls.target.copy(t),this.controls.enableRotate=!1,this.controls.update(),console.log("Switched to orthographic top view")}setPerspectiveView(){this.camera&&this.controls&&(this.activeCamera=this.camera,this.isOrthoView=!1,this.controls.object=this.camera,this.controls.enableRotate=!0,this.controls.update(),console.log("Switched to perspective view"))}calculateColors(t){if("default"===this.colorMode)return t.originalColors;let e=t.vertices,o=new Float32Array(e.length),i=e.length/3,n=1/0,r=-1/0;for(let t=0;t<i;t++){let o=e[3*t+1];n=Math.min(n,o),r=Math.max(r,o)}console.log(`Height range: ${n.toFixed(2)} to ${r.toFixed(2)}`);for(let t=0;t<i;t++){let i,a,s,l=(e[3*t+1]-n)/(r-n);switch(this.colorMode){case"height":l<.5?(i=0,a=2*l,s=1-2*l):(i=(l-.5)*2,a=1-(l-.5)*2,s=0);break;case"rainbow":let h=300*l,c=this.hslToRgb(h/360,1,.5);i=c[0],a=c[1],s=c[2];break;case"heat":l<.33?(i=3*l,a=0,s=0):l<.66?(i=1,a=(l-.33)*3,s=0):(i=1,a=1,s=(l-.66)*3);break;default:i=a=s=.7}o[3*t]=i,o[3*t+1]=a,o[3*t+2]=s}return o}hslToRgb(t,e,o){let i,n,r;if(0===e)i=n=r=o;else{let a=(t,e,o)=>(o<0&&(o+=1),o>1&&(o-=1),o<1/6)?t+(e-t)*6*o:o<.5?e:o<2/3?t+(e-t)*(2/3-o)*6:t,s=o<.5?o*(1+e):o+e-o*e,l=2*o-s;i=a(l,s,t+1/3),n=a(l,s,t),r=a(l,s,t-1/3)}return[i,n,r]}calculateHeightRange(t){let e=t.vertices,o=e.length/3,i=1/0,n=-1/0;for(let t=0;t<o;t++){let o=e[3*t+1];i=Math.min(i,o),n=Math.max(n,o)}this.minHeight=i,this.maxHeight=n}applyHeightFilter(t){let e=t.vertices,o=t.originalColors,i=e.length/3,n=[],r=[],a=this.minHeight+(this.maxHeight-this.minHeight)*this.heightFilterMin,s=this.minHeight+(this.maxHeight-this.minHeight)*this.heightFilterMax;for(let t=0;t<i;t++){let i=e[3*t],l=e[3*t+1],h=e[3*t+2];l>=a&&l<=s&&(n.push(i,l,h),r.push(o[3*t],o[3*t+1],o[3*t+2]))}return{vertices:new Float32Array(n),colors:new Float32Array(r),originalColors:new Float32Array(r),count:n.length/3}}setHeightFilter(t,e){this.heightFilterMin=Math.max(0,Math.min(1,t)),this.heightFilterMax=Math.max(0,Math.min(1,e)),this.heightFilterMin>this.heightFilterMax&&(this.heightFilterMin=this.heightFilterMax),this.currentPCDData&&this.createPointCloud(this.currentPCDData,!1)}resetHeightFilter(){this.heightFilterMin=0,this.heightFilterMax=1,this.currentPCDData&&this.createPointCloud(this.currentPCDData,!1)}setColorMode(t){if(this.colorMode=t,this.currentPCDData&&this.pointCloud){let t=this.applyHeightFilter(this.currentPCDData),e=this.calculateColors(t);this.pointCloud.geometry.setAttribute("color",new l.THS(e,3)),this.pointCloud.geometry.attributes.color.needsUpdate=!0}}setPointSize(t){this.pointCloud&&(this.pointCloud.material.size=t,this.pointCloud.material.needsUpdate=!0)}saveOriginalData(t,e,o){this.currentFormat=e,this.currentFileName=o;let i=t.originalVertices||t.vertices;this.originalPointData={vertices:new Float32Array(i),colors:t.originalColors?new Float32Array(t.originalColors):null,intensity:null,classification:null,count:t.count,format:e,fileName:o}}exportFilteredPointCloud(t){let e,o,i,n,r;if(!this.originalPointData||!this.currentPCDData)return void console.warn("没有可导出的点云数据");this.applyHeightFilter(this.currentPCDData);let a=this.originalPointData.vertices,s=this.originalPointData.colors,l=this.originalPointData.count,h=[],c=[];if(null===this.minHeight||null===this.maxHeight)return void console.warn("未计算高度范围");let d=this.minHeight+(this.maxHeight-this.minHeight)*this.heightFilterMin,u=this.minHeight+(this.maxHeight-this.minHeight)*this.heightFilterMax;for(let t=0;t<l;t++){let e=a[3*t+2];e>=d&&e<=u&&(h.push(a[3*t],a[3*t+1],a[3*t+2]),s&&c.push(s[3*t],s[3*t+1],s[3*t+2]))}let p={vertices:new Float32Array(h),colors:c.length>0?new Float32Array(c):null,intensity:null,classification:null,count:h.length/3,format:this.originalPointData.format,fileName:this.originalPointData.fileName},{blob:g,fileName:m}=(e=t||("las"===p.format?"pcd":p.format)||"pcd",o=p.fileName.replace(/\.(pcd|ply|las)$/i,""),i=`${o}_filtered.${e}`,{blob:"ply"===e?function(t){let{vertices:e,colors:o,intensity:i,count:n}=t,r=null!==o,a=null!==i,s=`ply
format ascii 1.0
element vertex ${n}
property float x
property float y
property float z
`;r&&(s+=`property uchar red
property uchar green
property uchar blue
`),a&&(s+=`property float intensity
`),s+=`end_header
`;let l=[];for(let t=0;t<n;t++){let n=e[3*t],s=e[3*t+1],h=e[3*t+2],c=`${n.toFixed(6)} ${s.toFixed(6)} ${h.toFixed(6)}`;if(r&&o){let e=Math.round(255*o[3*t]),i=Math.round(255*o[3*t+1]),n=Math.round(255*o[3*t+2]);c+=` ${e} ${i} ${n}`}a&&i&&(c+=` ${i[t].toFixed(2)}`),l.push(c)}return new Blob([s+l.join("\n")],{type:"text/plain"})}(p):function(t){let{vertices:e,colors:o,intensity:i,count:n}=t,r=null!==o,a=null!==i,s="x y z",l="4 4 4",h="F F F",c="1 1 1";r&&(s+=" rgb",l+=" 4",h+=" U",c+=" 1"),a&&(s+=" intensity",l+=" 4",h+=" F",c+=" 1");let d=`# .PCD v0.7 - Point Cloud Data file format
VERSION 0.7
FIELDS ${s}
SIZE ${l}
TYPE ${h}
COUNT ${c}
WIDTH ${n}
HEIGHT 1
VIEWPOINT 0 0 0 1 0 0 0
POINTS ${n}
DATA ascii
`,u=[];for(let t=0;t<n;t++){let n=e[3*t],s=e[3*t+1],l=e[3*t+2],h=`${n.toFixed(6)} ${s.toFixed(6)} ${l.toFixed(6)}`;if(r&&o){let e=Math.round(255*o[3*t])<<16|Math.round(255*o[3*t+1])<<8|Math.round(255*o[3*t+2]);h+=` ${e}`}a&&i&&(h+=` ${i[t].toFixed(2)}`),u.push(h)}return new Blob([d+u.join("\n")],{type:"text/plain"})}(p),fileName:i});n=URL.createObjectURL(g),(r=document.createElement("a")).href=n,r.download=m,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(n),console.log(`导出完成: ${m}, ${p.count} 个点`)}onCanvasClick(t){if(!this.waypointMode||!this.renderer||!this.camera)return;let e=this.renderer.domElement.getBoundingClientRect();this.mouse.x=(t.clientX-e.left)/e.width*2-1,this.mouse.y=-(2*((t.clientY-e.top)/e.height))+1,this.raycaster.setFromCamera(this.mouse,this.camera);let o=new l.Zcv(new l.Pq0(0,1,0),0),i=new l.Pq0;this.raycaster.ray.intersectPlane(o,i),i&&(i.y=0,this.addWaypoint(i))}addWaypoint(t){let e=this.waypoints.length,o=new l.Gu$(.5,8,6),i=new l.V9B({color:0xff0000}),n=new l.eaF(o,i);n.position.copy(t);let r=document.createElement("canvas"),a=r.getContext("2d");r.width=28,r.height=28,a.fillStyle="white",a.fillRect(0,0,28,28),a.fillStyle="black",a.font="bold 32px Arial",a.textAlign="center",a.fillText((e+1).toString(),13,25);let s=new l.GOR(r),h=new l.RoJ({map:s}),c=new l.kxk(h);c.scale.set(1,1,1),c.position.copy(t),c.position.y+=1.5;let d=new l.PTz(0,0,0,1),u=new l.Pq0(-t.z,-t.x,t.y),p={id:e,name:`waypoint${e+1}`,position:t.clone(),originalPosition:u.clone(),quaternion:d.clone(),mesh:n,label:c};this.waypoints.push(p),this.waypointGroup.add(n),this.waypointGroup.add(c),this.waypoints.length>1&&this.connectWaypoints(this.waypoints.length-2,this.waypoints.length-1),this.onWaypointCountChange(this.waypoints.length),console.log(`Waypoint ${p.name} added at:`,t)}connectWaypoints(t,e){if(t>=0&&t<this.waypoints.length&&e>=0&&e<this.waypoints.length&&t!==e){let o=this.waypoints[t].position,i=this.waypoints[e].position,n=new l.LoY().setFromPoints([o,i]),r=new l.mrM({color:65280,linewidth:3}),a=new l.N1A(n,r);this.waypointConnections.push({from:t,to:e,line:a}),this.connectionGroup.add(a),console.log(`Connected waypoint ${t} to ${e}`)}}clearWaypoints(){this.waypoints.forEach(t=>{this.waypointGroup.remove(t.mesh),this.waypointGroup.remove(t.label),t.mesh.geometry.dispose(),t.mesh.material.dispose(),t.label.material.dispose()}),this.waypointConnections.forEach(t=>{this.connectionGroup.remove(t.line),t.line.geometry.dispose(),t.line.material.dispose()}),this.waypoints=[],this.waypointConnections=[],this.onWaypointCountChange(0),console.log("All waypoints cleared")}removeLastWaypoint(){if(0===this.waypoints.length)return void console.log("没有可删除的路点");let t=this.waypoints.pop();this.waypointGroup.remove(t.mesh),this.waypointGroup.remove(t.label),t.mesh.geometry.dispose(),t.mesh.material.dispose(),t.label.material.dispose();let e=[];for(let o=this.waypointConnections.length-1;o>=0;o--){let i=this.waypointConnections[o];(i.from===t.id||i.to===t.id)&&(this.connectionGroup.remove(i.line),i.line.geometry.dispose(),i.line.material.dispose(),e.push(o))}e.forEach(t=>{this.waypointConnections.splice(t,1)}),this.onWaypointCountChange(this.waypoints.length),console.log(`路点 ${t.name} 已删除`)}exportWaypoints(){if(0===this.waypoints.length)return void alert("没有可导出的路点");let t="task:\n";t+="  task1:\n",this.waypoints.forEach(e=>{t+=`    - ${e.name}
`}),t+="\nwaypoint:\n",this.waypoints.forEach(e=>{let o=[e.originalPosition.x.toFixed(6),e.originalPosition.y.toFixed(6),e.originalPosition.z.toFixed(6),e.quaternion.x.toFixed(6),e.quaternion.y.toFixed(6),e.quaternion.z.toFixed(6),e.quaternion.w.toFixed(6)];t+=`  ${e.name}: [${o.join(", ")}]
`});let e=new Blob([t],{type:"text/yaml"}),o=URL.createObjectURL(e),i=document.createElement("a");i.href=o,i.download="waypoints.yaml",i.click(),URL.revokeObjectURL(o),console.log("Waypoints exported")}toggleWaypointMode(t){this.waypointMode=t,console.log("Waypoint mode:",t)}dispose(){this.renderer&&(this.renderer.dispose(),this.container.contains(this.renderer.domElement)&&this.container.removeChild(this.renderer.domElement))}constructor(t,e,o,i){(0,s._)(this,"scene",null),(0,s._)(this,"camera",null),(0,s._)(this,"orthoCamera",null),(0,s._)(this,"activeCamera",null),(0,s._)(this,"isOrthoView",!1),(0,s._)(this,"renderer",null),(0,s._)(this,"controls",null),(0,s._)(this,"pointCloud",null),(0,s._)(this,"currentPCDData",null),(0,s._)(this,"colorMode","height"),(0,s._)(this,"minHeight",null),(0,s._)(this,"maxHeight",null),(0,s._)(this,"heightFilterMin",0),(0,s._)(this,"heightFilterMax",1),(0,s._)(this,"originalPointData",null),(0,s._)(this,"currentFileName","pointcloud"),(0,s._)(this,"currentFormat","unknown"),(0,s._)(this,"pcdLoader",new c.n),(0,s._)(this,"plyLoader",new d.Z),(0,s._)(this,"waypointMode",!1),(0,s._)(this,"waypoints",[]),(0,s._)(this,"waypointConnections",[]),(0,s._)(this,"waypointGroup",new l.YJl),(0,s._)(this,"connectionGroup",new l.YJl),(0,s._)(this,"raycaster",new l.tBo),(0,s._)(this,"mouse",new l.I9Y),(0,s._)(this,"defaultCameraPosition",{x:25,y:25,z:-25}),(0,s._)(this,"container",void 0),(0,s._)(this,"onPointCountChange",void 0),(0,s._)(this,"onLoadStatusChange",void 0),(0,s._)(this,"onWaypointCountChange",void 0),(0,s._)(this,"animate",()=>{var t;requestAnimationFrame(this.animate),null==(t=this.controls)||t.update(),this.renderer&&this.scene&&this.activeCamera&&this.renderer.render(this.scene,this.activeCamera)}),(0,s._)(this,"abortController",null),(0,s._)(this,"worker",null),(0,s._)(this,"progressiveRenderEnabled",!0),(0,s._)(this,"downsampleLevel",1),this.container=t,this.onPointCountChange=e,this.onLoadStatusChange=o,this.onWaypointCountChange=i,this.init()}}let p=()=>{let[t]=(0,a.ok)(),e=(0,n.useRef)(null),o=(0,n.useRef)(null),r=(0,n.useRef)(null),s=(0,n.useRef)(null),l=(0,n.useRef)(null),h=(0,n.useRef)(null),c=(0,n.useRef)(null),d=(0,n.useRef)(null),p=(0,n.useRef)(null),g=(0,n.useRef)(null),m=(0,n.useRef)(null);(0,n.useRef)(null);let y=(0,n.useRef)(null),C=(0,n.useRef)(null),w=(0,n.useRef)(null);(0,n.useEffect)(()=>{var i;if(!e.current)return;o.current=new u(e.current,t=>{C.current&&(C.current.textContent=`Points: ${t.toLocaleString()}`)},t=>{w.current&&(w.current.textContent=t,x())},t=>{y.current&&(y.current.textContent=`路点数: ${t}`)});let n=o.current,r=t.get("url")||t.get("file");r&&(console.log("Loading from URL parameter:",r),n.loadFromURL(r),s.current&&(s.current.value=r));let a=()=>n.onWindowResize();window.addEventListener("resize",a);let l=t=>{n.waypointMode&&n.onCanvasClick(t)};null==(i=n.renderer)||i.domElement.addEventListener("click",l);let h=t=>{"Backspace"===t.key&&n.waypointMode&&(t.preventDefault(),n.removeLastWaypoint())};return document.addEventListener("keydown",h),()=>{var t;window.removeEventListener("resize",a),null==(t=n.renderer)||t.domElement.removeEventListener("click",l),document.removeEventListener("keydown",h),n.dispose()}},[t]);let f=()=>{if(!o.current||!s.current)return;let t=s.current.value.trim();t&&o.current.loadFromURL(t)},x=()=>{if(!o.current||!d.current||!p.current||!g.current||!m.current)return;let t=parseFloat(d.current.value)/100,e=parseFloat(p.current.value)/100;o.current.setHeightFilter(t,e);let i=o.current;if(null!==i.minHeight&&null!==i.maxHeight){let o=i.minHeight+(i.maxHeight-i.minHeight)*t,n=i.minHeight+(i.maxHeight-i.minHeight)*e;g.current.textContent=o.toFixed(1),m.current.textContent=n.toFixed(1)}};return(0,i.jsx)("div",{className:"pcd-viewer-container",children:(0,i.jsxs)("div",{ref:e,id:"container",children:[(0,i.jsxs)("div",{id:"controls",children:[(0,i.jsx)("div",{children:"Point Cloud Viewer"}),(0,i.jsx)("input",{type:"file",id:"fileInput",ref:r,accept:".pcd,.las,.ply",onChange:t=>{var e;let i=null==(e=t.target.files)?void 0:e[0];if(!i||!o.current)return;let n=i.name.toLowerCase().split(".").pop();"pcd"===n?o.current.loadPCDFile(i):"ply"===n?o.current.loadPLYFile(i):"las"===n&&o.current.loadLASFile(i)}}),(0,i.jsxs)("div",{style:{marginTop:8},children:[(0,i.jsx)("input",{type:"text",ref:s,placeholder:"或者输入点云URL",onKeyDown:t=>{"Enter"===t.key&&f()},style:{width:"70%",padding:"4px 6px",fontSize:11,background:"#333",color:"white",border:"1px solid #555",borderRadius:3,boxSizing:"border-box"}}),(0,i.jsx)("button",{onClick:f,style:{marginTop:1},children:"加载URL"})]}),(0,i.jsxs)("div",{style:{marginTop:10},children:[(0,i.jsx)("button",{onClick:()=>{var t;null==(t=o.current)||t.resetCamera()},children:"重置相机"}),(0,i.jsx)("button",{onClick:()=>{var t;null==(t=o.current)||t.setTopView(),l.current&&(l.current.max="2.5")},children:"正交俯视"}),(0,i.jsx)("button",{onClick:()=>{var t,e;if(null==(t=o.current)||t.setPerspectiveView(),l.current){let t=parseFloat(l.current.value);l.current.max="1.1",t>1.1&&(l.current.value="1.1",null==(e=o.current)||e.setPointSize(1.1),h.current&&(h.current.textContent="1.10"))}},children:"透视视图"})]}),(0,i.jsxs)("div",{style:{marginTop:10},children:[(0,i.jsxs)("label",{children:["点大小:"," ",(0,i.jsx)("input",{type:"range",id:"pointSizeSlider",ref:l,min:"0.01",max:"1.1",defaultValue:"0.1",step:"0.01",onInput:()=>{if(!o.current||!l.current||!h.current)return;let t=parseFloat(l.current.value);o.current.setPointSize(t),h.current.textContent=t.toFixed(2)}})]}),(0,i.jsx)("span",{id:"pointSizeValue",ref:h,children:"0.10"})]}),(0,i.jsxs)("div",{style:{marginTop:10},children:[(0,i.jsx)("label",{htmlFor:"colorMode",children:"着色模式:"}),(0,i.jsxs)("select",{id:"colorMode",ref:c,onChange:()=>{o.current&&c.current&&o.current.setColorMode(c.current.value)},children:[(0,i.jsx)("option",{value:"height",selected:!0,children:"高度渐变"}),(0,i.jsx)("option",{value:"rainbow",children:"彩虹"}),(0,i.jsx)("option",{value:"heat",children:"热力图"})]})]}),(0,i.jsxs)("div",{style:{marginTop:10},children:[(0,i.jsx)("label",{htmlFor:"downsample",children:"降采样:"}),(0,i.jsxs)("select",{id:"downsample",onChange:t=>{let e=parseFloat(t.target.value);o.current&&o.current.setDownsampleLevel(e)},defaultValue:"1",children:[(0,i.jsx)("option",{value:"1",children:"无 (原始)"}),(0,i.jsx)("option",{value:"2",children:"2x (50%点)"}),(0,i.jsx)("option",{value:"4",children:"4x (25%点)"}),(0,i.jsx)("option",{value:"8",children:"8x (12.5%点)"}),(0,i.jsx)("option",{value:"16",children:"16x (6.25%点)"})]})]}),(0,i.jsxs)("div",{style:{marginTop:10},children:[(0,i.jsx)("label",{children:"高度过滤器:"}),(0,i.jsxs)("div",{children:[(0,i.jsxs)("label",{children:["最小:"," ",(0,i.jsx)("input",{type:"range",id:"minHeightSlider",ref:d,min:"0",max:"100",defaultValue:"0",step:"0.1",onChange:x})]}),(0,i.jsx)("span",{id:"minHeightValue",ref:g,children:"0.0"})]}),(0,i.jsxs)("div",{children:[(0,i.jsxs)("label",{children:["最大:"," ",(0,i.jsx)("input",{type:"range",id:"maxHeightSlider",ref:p,min:"0",max:"100",defaultValue:"100",step:"0.1",onChange:x})]}),(0,i.jsx)("span",{id:"maxHeightValue",ref:m,children:"1000.0"})]}),(0,i.jsx)("button",{onClick:()=>{if(!o.current||!d.current||!p.current||!g.current||!m.current)return;o.current.resetHeightFilter(),d.current.value="0",p.current.value="100";let t=o.current;null!==t.minHeight&&null!==t.maxHeight&&(g.current.textContent=t.minHeight.toFixed(1),m.current.textContent=t.maxHeight.toFixed(1))},children:"重置"}),(0,i.jsx)("button",{onClick:()=>{o.current&&o.current.exportFilteredPointCloud()},style:{marginLeft:5},children:"导出"})]}),(0,i.jsx)("div",{style:{marginTop:15,borderTop:"1px solid #444",paddingTop:10}}),(0,i.jsx)("div",{children:"鼠标: 旋转\xb7缩放\xb7平移"}),(0,i.jsx)("div",{children:"ROS坐标系: 红=X(前), 绿=Y(左), 蓝=Z(上)"})]}),(0,i.jsxs)("div",{id:"info",children:[(0,i.jsx)("div",{id:"pointCount",ref:C,children:"Points: 0"}),(0,i.jsx)("div",{id:"loadStatus",ref:w,children:"Ready"})]})]})})},g=document.getElementById("root");g&&(0,r.createRoot)(g).render((0,i.jsx)(n.StrictMode,{children:(0,i.jsx)(()=>(0,i.jsx)(a.Kd,{children:(0,i.jsxs)(a.BV,{children:[(0,i.jsx)(a.qh,{path:"/",element:(0,i.jsx)(p,{})}),(0,i.jsx)(a.qh,{path:"*",element:(0,i.jsx)(p,{})})]})}),{})}))}},s={};function l(t){var e=s[t];if(void 0!==e)return e.exports;var o=s[t]={exports:{}};return a[t](o,o.exports,l),o.exports}l.m=a,e=Object.getPrototypeOf?t=>Object.getPrototypeOf(t):t=>t.__proto__,l.t=function(o,i){if(1&i&&(o=this(o)),8&i||"object"==typeof o&&o&&(4&i&&o.__esModule||16&i&&"function"==typeof o.then))return o;var n=Object.create(null);l.r(n);var r={};t=t||[null,e({}),e([]),e(e)];for(var a=2&i&&o;("object"==typeof a||"function"==typeof a)&&!~t.indexOf(a);a=e(a))Object.getOwnPropertyNames(a).forEach(t=>{r[t]=()=>o[t]});return r.default=()=>o,l.d(n,r),n},l.d=(t,e)=>{for(var o in e)l.o(e,o)&&!l.o(t,o)&&Object.defineProperty(t,o,{enumerable:!0,get:e[o]})},l.u=t=>"static/js/async/"+t+".ec7c352a.js",l.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),l.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},o=[],l.O=(t,e,i,n)=>{if(e){n=n||0;for(var r=o.length;r>0&&o[r-1][2]>n;r--)o[r]=o[r-1];o[r]=[e,i,n];return}for(var a=1/0,r=0;r<o.length;r++){for(var[e,i,n]=o[r],s=!0,h=0;h<e.length;h++)(!1&n||a>=n)&&Object.keys(l.O).every(t=>l.O[t](e[h]))?e.splice(h--,1):(s=!1,n<a&&(a=n));if(s){o.splice(r--,1);var c=i();void 0!==c&&(t=c)}}return t},l.p="./",l.b=document.baseURI||self.location.href,i={410:0},l.O.j=t=>0===i[t],n=(t,e)=>{var o,n,[r,a,s]=e,h=0;if(r.some(t=>0!==i[t])){for(o in a)l.o(a,o)&&(l.m[o]=a[o]);if(s)var c=s(l)}for(t&&t(e);h<r.length;h++)n=r[h],l.o(i,n)&&i[n]&&i[n][0](),i[n]=0;return l.O(c)},(r=self.webpackChunkpoint_cloud_viewer=self.webpackChunkpoint_cloud_viewer||[]).forEach(n.bind(null,0)),r.push=n.bind(null,r.push.bind(r));var h=l.O(void 0,["783","535","558"],()=>l(556));h=l.O(h)})();