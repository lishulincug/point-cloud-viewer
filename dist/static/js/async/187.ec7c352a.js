self.onmessage=e=>{let{type:t,data:r}=e.data;try{let e;switch(t){case"parse_pcd":e=function(e){let t=new TextDecoder("utf-8"),r=new Uint8Array(e),l=0,a=t.decode(r.slice(0,Math.min(r.length,4096))),n=a.indexOf("DATA");if(-1===n)throw Error("无效的 PCD 文件格式");let o=a.slice(0,n).split("\n"),s=0,i="ascii",g=[],c=[];for(let e of o){let t=e.trim().split(/\s+/);"POINTS"===t[0]?s=parseInt(t[1]):"FIELDS"===t[0]?g=t.slice(1):"SIZE"===t[0]?c=t.slice(1).map(Number):"TYPE"===t[0]&&t.slice(1)}let f=a.indexOf("\n",n);i=a.slice(n+5,f).trim().toLowerCase(),l=new TextEncoder().encode(a.slice(0,f+1)).length;let p=new Float32Array(3*s),d=new Float32Array(3*s),u=new Float32Array(3*s),F=g.includes("rgb")||g.includes("rgba"),w=-1!==g.indexOf("rgb")?g.indexOf("rgb"):g.indexOf("rgba");if("binary"===i){let t=new DataView(e,l),r=c.reduce((e,t)=>e+t,0);for(let e=0;e<s;e++){let l=e*r,a=t.getFloat32(l,!0),n=t.getFloat32(l+4,!0),o=t.getFloat32(l+8,!0);if(d[3*e]=a,d[3*e+1]=n,d[3*e+2]=o,p[3*e]=-n,p[3*e+1]=o,p[3*e+2]=-a,F&&-1!==w){let r=0;for(let e=0;e<w;e++)r+=c[e];let a=t.getUint32(l+r,!0);u[3*e]=(a>>16&255)/255,u[3*e+1]=(a>>8&255)/255,u[3*e+2]=(255&a)/255}else u[3*e]=.7,u[3*e+1]=.7,u[3*e+2]=.7;if(e%1e4==0){let t={type:"progress",percent:Math.round(e/s*100),message:`解析中... ${e.toLocaleString()} / ${s.toLocaleString()}`};self.postMessage(t)}}}else{let e=t.decode(r.slice(l)).trim().split("\n");for(let t=0;t<Math.min(e.length,s);t++){let r=e[t].trim().split(/\s+/),l=parseFloat(r[0]),a=parseFloat(r[1]),n=parseFloat(r[2]);if(d[3*t]=l,d[3*t+1]=a,d[3*t+2]=n,p[3*t]=-a,p[3*t+1]=n,p[3*t+2]=-l,u[3*t]=.7,u[3*t+1]=.7,u[3*t+2]=.7,t%1e4==0){let e={type:"progress",percent:Math.round(t/s*100),message:`解析中... ${t.toLocaleString()} / ${s.toLocaleString()}`};self.postMessage(e)}}}return{vertices:p,colors:u,count:s,originalVertices:d}}(r);break;case"parse_las":e=function(e){let t,r=new DataView(e);if("LASF"!==String.fromCharCode(r.getUint8(0),r.getUint8(1),r.getUint8(2),r.getUint8(3)))throw Error("无效的 LAS 文件格式");let l=r.getUint8(24),a=r.getUint8(25),n=r.getUint32(96,!0),o=r.getUint8(104),s=r.getUint16(105,!0);t=1===l&&a<4?r.getUint32(107,!0):Number(r.getBigUint64(247,!0));let i=r.getFloat64(131,!0),g=r.getFloat64(139,!0),c=r.getFloat64(147,!0),f=r.getFloat64(155,!0),p=r.getFloat64(163,!0),d=r.getFloat64(171,!0),u=new Float32Array(3*t),F=new Float32Array(3*t),w=new Float32Array(3*t),m=[2,3,5,7,8,10].includes(o),U=2===o?20:28*(3===o);for(let e=0;e<t;e++){let l=n+e*s,a=r.getInt32(l,!0),o=r.getInt32(l+4,!0),h=r.getInt32(l+8,!0),y=a*i+f,b=o*g+p,S=h*c+d;if(F[3*e]=y,F[3*e+1]=b,F[3*e+2]=S,u[3*e]=-b,u[3*e+1]=S,u[3*e+2]=-y,m&&U>0?(w[3*e]=r.getUint16(l+U,!0)/65535,w[3*e+1]=r.getUint16(l+U+2,!0)/65535,w[3*e+2]=r.getUint16(l+U+4,!0)/65535):(w[3*e]=.7,w[3*e+1]=.7,w[3*e+2]=.7),e%5e4==0){let r={type:"progress",percent:Math.round(e/t*100),message:`解析中... ${e.toLocaleString()} / ${t.toLocaleString()}`};self.postMessage(r)}}return{vertices:u,colors:w,count:t,originalVertices:F}}(r);break;default:throw Error(`不支持的解析类型: ${t}`)}let l={type:"complete",data:e},a=[e.vertices.buffer,e.colors.buffer];e.originalVertices&&a.push(e.originalVertices.buffer),self.postMessage(l,{transfer:a})}catch(t){let e={type:"error",error:t.message};self.postMessage(e)}};