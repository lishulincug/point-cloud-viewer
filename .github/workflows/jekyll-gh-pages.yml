# GitHub Actions: 构建并通过 SSH/rsync 部署
# 说明：
# - 触发：push 到 main 分支（可按需改为 release 标签或手动触发）
# - 请在仓库 Secrets 中配置：DEPLOY_HOST, DEPLOY_USER, DEPLOY_KEY (私钥)
# - 如果构建产物在非 ./dist 目录，调整 path 与 rsync 的源路径
name: Build and Deploy

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Prepare SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

      - name: Deploy via rsync over SSH
        env:
          RSYNC_RSH: "ssh -o StrictHostKeyChecking=no -i ~/.ssh/deploy_key"
        run: |
          # 将 ./dist/ 换成你的构建输出目录（例如: build/ 或 public/）
          rsync -avz --delete ./dist/ ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}:/var/www/myapp/
